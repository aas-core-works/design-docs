<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Code Contracts - Design Docs for aasx-core</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Code Contracts";
    var mkdocs_page_input_path = "contracts.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Design Docs for aasx-core</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../general-design-decisions/">General Design Decisions</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../simplified-python/">Simplified Python</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../data-structures-and-operations/">Data Structures and Operations</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Code Contracts</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#definition-of-contracts">Definition of Contracts</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#identifier">Identifier</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#error-messages">Error Messages</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#error-type">Error Type</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#severity">Severity</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#contracts-and-serialization">Contracts and Serialization</a>
    </li>
    </ul>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../deserialization-scripts/">De/serialization Scripts</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../testing/">Testing</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../naming-conventions/">Naming Conventions</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../roadmap/">Roadmap</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Design Docs for aasx-core</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Code Contracts</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="code-contracts">Code Contracts<a class="headerlink" href="#code-contracts" title="Permanent link">#</a></h1>
<p>The specification of <a href="../data-structures-and-operations/">operations</a> in our <a href="../general-design-decisions/#meta-model">meta-model</a> should include the <a href="https://en.wikipedia.org/wiki/Design_by_contract">code contracts</a> such as pre-conditions and post-conditions.</p>
<p>The contracts can be trivial (such as specifying a range of a property), as well as very complex expressions (the length of this list needs to be divisble by three and the first element needs to be larger than the sum of all the other elements).</p>
<p>The <a href="../general-design-decisions/#code-generators">code generators</a> transpile contracts so that they are <strong>included in the implementation</strong>.
This has the following benefits:
* The <em>implementation</em> of the library allows thus for <strong>deeper testing</strong> as contracts are checked during debuging, testing and in production.</p>
<ul>
<li>
<p>Additionally, the <em>implementation</em> can be analyzed with <strong>static analyzers</strong> and <strong>automatic testers</strong> (such as <a href="https://github.com/pschanely/CrossHair">crosshair</a> and <a href="https://github.com/mristin/icontract-hypothesis">icontract-hypothesis</a>), which can only work with code with tight-enough contracts.</p>
</li>
<li>
<p>The contracts are included in the <strong>documentation of the implementation</strong>.
  Hence the users can rely on formal unambiguous documentation.
  Moreover, the documentation in human language tends to "rot", while contracts are continuously and automatically verified in testing or in production.</p>
</li>
</ul>
<h2 id="definition-of-contracts">Definition of Contracts<a class="headerlink" href="#definition-of-contracts" title="Permanent link">#</a></h2>
<p>TODO (Marko &amp; Nico &amp; Robert, 2021-03-28): Discuss</p>
<p>The contracts are written in <a href="../simplified-python/">our simplified Python</a> and transpiled by <a href="../general-design-decisions/#code-generators">code generators</a> into the implementation stubs.</p>
<p>As we could <strong>not support invariants</strong> in most languages, we decide to define contracts as <strong>pre-conditions</strong> and <strong>post-conditions</strong> of <strong><a href="../data-structures-and-operations/">operations</a></strong>.</p>
<p>The contracts are defined as <a href="https://en.wikipedia.org/wiki/Python_syntax_and_semantics#Decorators">function decorators</a> on the opeartions:</p>
<pre><code class="language-python">@require(
    condition=lambda x, y: x &lt; y,
    identifier=&quot;x_smaller_than_y&quot;,
    error=lambda x, y: &quot;x (%d) must be smaller than y (%d).&quot; % (
        x, y),
    severity=ALWAYS,
    error_type=ValueError)
@ensure(
    condition=lambda x, y, result: result &gt; x * y,
    identifier=&quot;result_greater_than_product&quot;,
    error=lambda x, y, result: 
        (&quot;result (%d) must be greater than the product (%d)&quot;
        &quot;of x (%d) and y (%d)&quot;) % (result, x * y, x, y),
    severity=DEBUG,
    error_type=AssertionError 
)
def some_operation(x: int, y: int) -&gt; int:
    ...
</code></pre>
<p>The contract decorators (<code>require</code> and <code>ensure</code>) as well as constants (such as <code>ALWAYS</code>) live in <code>aasx_core_gen.contracts</code> module.</p>
<h3 id="identifier">Identifier<a class="headerlink" href="#identifier" title="Permanent link">#</a></h3>
<p>Each contract must have an identifier unique to the operation.
In implementation languages where we can not produce an error message, we will at least display the identifier to the user.</p>
<p>If the identifier is omitted, it equals the body of the condition lambda function.</p>
<h3 id="error-messages">Error Messages<a class="headerlink" href="#error-messages" title="Permanent link">#</a></h3>
<p>The contracts should also include <strong>an error message</strong>.
The error message should support <a href="https://en.wikipedia.org/wiki/Printf_format_string">printf format strings</a> so that we can include the actual offending values in the message as well.
This is important for contracts which are enforced <strong>in production</strong> catching <strong>rare and hard-to-reproduce bugs</strong>.</p>
<p>If the error message is omitted, the code generator will try to infer the format string based on the types of the arguments of the contract condition.</p>
<h3 id="error-type">Error Type<a class="headerlink" href="#error-type" title="Permanent link">#</a></h3>
<p>While some languages, such as Golang, panic on contract violation, other languages such as Python and C# allow us to distinguish between the types of errors on contract violation.
We represent the error types by using subclasses of Python <code>Exception</code>:</p>
<ul>
<li><code>ValueError</code> for violations where the caller supplied invalid arguments.
  This error is mapped to <code>System.InvalidArgumentError</code> in C# or <code>std::invalid_argument</code> in C++.</li>
<li><code>AssertionError</code> for logical errors (<em>e.g.</em>, operation called on the invalid state of the object). 
  This error is mapped to <code>System.InvalidOperationException</code> in C# and <code>std::logic_error</code> in C++.</li>
</ul>
<p>The default is <code>AssertionError</code>.</p>
<h3 id="severity">Severity<a class="headerlink" href="#severity" title="Permanent link">#</a></h3>
<p>Each contract is given a  <strong>severity</strong> which determines when it is enforced:</p>
<ul>
<li><code>ALWAYS</code>, always enforced, including in production,</li>
<li><code>DEBUG</code>, enforced both in our and external tests, and</li>
<li><code>DEBUG_OURS</code>, enforced only in our tests, but excluded in external tests,</li>
<li><code>DEBUG_SLOW</code> and <code>DEBUG_OURS_SLOW</code>, enforced only in the respective tests for which we know that the amount data is small.<br>
  <br>
  This allows us to enforce contracts with exploding computational complexity.</li>
</ul>
<p>The default for pre-conditions is <code>ALWAYS</code>, while it is <code>DEBUG</code> for post-conditions.</p>
<h2 id="contracts-and-serialization">Contracts and Serialization<a class="headerlink" href="#contracts-and-serialization" title="Permanent link">#</a></h2>
<p>The contracts are a tool for improving the <a href="https://en.wikipedia.org/wiki/Correctness_(computer_science)">correctness</a> of the code.
They are not meant to be used as validation of the input (<em>e.g.</em>, a JSON file to be imported).</p>
<p>In our setting, this means that the validation of the input is part of the <a href="../deserialization-scripts/">deserialization scripts</a>.
 They need to check that the input is correct and conforms to the meta-model, and report the errors eventually to the user.
In contrast, the contracts give us a certain assurance that the de-serialized objects are <strong>internally consistent</strong> and conform to our meta-model.</p>
<p>In other words, the <a href="../deserialization-scripts/">deserialization scripts</a> verify the <strong>external data</strong>, while contracts verify the <strong>internal data</strong>.
For example, we can use contracts to ensure that our deserialization works.
Instead of writing tons of unit tests, we rely on the contracts to be verified during testing.
A test boils down to simply de-serializing the example JSONs.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../deserialization-scripts/" class="btn btn-neutral float-right" title="De/serialization Scripts">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../data-structures-and-operations/" class="btn btn-neutral" title="Data Structures and Operations"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../data-structures-and-operations/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../deserialization-scripts/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
